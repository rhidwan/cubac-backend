{% load static %}

<div class="card shadow mb-4">
    <div class="card-header py-3">
      {% if not request.user.user_type == "0" %}
      <h6 class="m-0 font-weight-bolder text-primary ">Call Back
        <div class="float-right">
          <a href="{% url 'callback_report' %}" data-toggle="modal" data-title="Generate New report" data-target="#CallBackForm" class="btn btn-sm btn-primary">Generate Report</a>

          <a href="{% url 'create_callback' %}" data-toggle="modal" data-title="Create New Callback" data-target="#CallBackForm" class="btn btn-sm btn-primary">New
            Callback</a>
          </div>
      {% else %}
      <h6 class="m-0 font-weight-bolder text-primary ">Service Request
        <div class="float-right">
          <a href="{% url 'client_callback_report' %}" data-toggle="modal" data-title="Generate New report" data-target="#CallBackForm" class="btn btn-sm btn-primary">Generate Report</a></span>

          <a href="{% url 'create_callback' %}" data-toggle="modal" data-title="New Service Request" data-target="#CallBackForm" class="btn btn-sm btn-primary">New
            Service Request</a>
          </div>
      {% endif %}
      </h6>
    </div>

    <div class="card-body">
      {% if callbacks %}
      <div class="row mb-1">
        <div class="col-4 offset-8">
            <input type="search" id="callback-search" value="" class="text-muted form-control" placeholder="Search">
        </div>
      </div>
      <div class="accordion" id="callbackaccordion">
        
        {% for callback in callbacks %}
        <div class="card border border-primary mb-2">
          <div class="card-header bg-default" id="callback{{forloop.counter}}e">
            <div class="row" data-toggle="collapse" data-target="#collapsecallback{{forloop.counter}}" aria-expanded="true"
              aria-controls="collapsecallback{{forloop.counter}}">
       
                <div class="col-4 mb-1">
                  <p class="font-weight-bold  m-0 ">Unit:</p>
                  <p class="m-9">{{callback.unit}}</p>
                </div>
                <div class="col-4 mb-1">
                  <p class="font-weight-bold m-0">Call Date: {% if callback.status == 0%}
                    <span class="float-right text-weight-light badge badge-danger badge-pill" >
                      {{callback.get_status_display}}</span>
                      {% else %}
                    <span class="float-right text-weight-light badge badge-success badge-pill" >
                      {{callback.get_status_display}}</span>
                      
                      {% endif %}
                  </p>
                  <p class=" m-0">{{callback.call_date|date:'M d H:i'}}</p>
                </div>
                <div class="col-4 mb-1">
                  <p class="font-weight-bold   m-0">Latest Response: </p>
                  <p class=" m-0">{{callback.callresponse_set.all.0.response_time|date:'M d H:i'}}</p>
                </div>
        
              <div class="col-12 mb-2">
                    <span class="font-weight-bold text-primary  m-0">{% if request.user.user_type == "0" %}Observation: {% else %}Problem: {% endif  %} </span>{{callback.callresponse_set.all.0.problem}}
              </div>
              <div class="col-12 mb-2">
                <span class="font-weight-bold text-primary m-0">{% if request.user.user_type == "0" %}Feedback: {% else %}Solution: {% endif  %} </span> {{callback.callresponse_set.all.0.solution}}
              </div>  
              <div class="col-6 mb-2">
                <span class="font-weight-bold m-0">Respond By: </span> {{callback.callresponse_set.all.0.response_by}}
              </div>
              <div class="col-6 mb-2">
                <span class="font-weight-bold m-0">Inserted By: </span> {{callback.uploaded_by}}
              </div>


                    <!-- {% if callback.status ==  0 %}
                    <span class="badge badge-pill badge-danger float-right">{{callback.get_status_display}}</span>
                    {% else %}
                    <span class="badge badge-pill badge-success float-right">{{callback.get_status_display}}</span>
                    {% endif %} -->
                  
            </div>
          </div>
          <div id="collapsecallback{{forloop.counter}}" class="collapse" aria-labelledby="callback{{forloop.counter}}"
            data-parent="#callbackaccordion">
            <div class="card-body">
              {% if callback.callresponse_set.all|length %}
              {% for callresponse in callback.callresponse_set.all %}
              <!-- Subtask Loop Start -->
              <div class="row mb-2 border-bottom">
                <div class="col-3">
                  <div class="mb-2">
                    {% if callresponse.attachment %}
                    <a href="{{callresponse.attachment.url}}" class="image">
                      <img  class="img-fluid img-thumbnail" src="{{callresponse.attachment_thumb.url}}" alt="avatar"/> 
                    </a>
                    {% else %}
                      <span><i class="far fa-image fa-4x"></i></span>
                    {% endif %}
                  </div>
                  <div class="mt-1 mb-2">
                    {% if callresponse.file_attachment %}
                        <p>
                            <a href="{{callresponse.file_attachment.url}}" download="download"><i class="fas fa-paperclip"></i>File</a>
                        </p>
                    {% endif %} 
                  </div>                    
                </div>
                <div class="col-9">
                  <div class="row">
                    <div class="mb-2 col-7">
                      <span class="font-weight-bold   m-0">Respond By: </span>{{callresponse.response_by}}
                    </div>
                    <div class="mb-2 col-5">
                      <span class="font-weight-bold   m-0">Date: </span>{{callresponse.response_time|date:'M d H:i'}}
                    </div> 
                  </div>
                  <div class="row">
                    <div class="mb-2 col-12">
                      <span class="font-weight-bold   m-0">{% if request.user.user_type == "0" %}Observation: {% else %}Problem: {% endif  %}  </span>{{callresponse.problem}}
                    </div>
                    <div class="mb-2 col-12">
                      <span class="font-weight-bold   m-0">{% if request.user.user_type == "0" %}Feedback: {% else %}Solution: {% endif  %} </span> {{callresponse.solution}}</p>
                    </div>
                    <div class="mb-2 col-12">
                      <p class=" m-0 text-muted text-sm">{% if request.user.user_type == "0" %}Feedback {% else %}Inserted {% endif  %}By: {{callback.uploaded_by}}</p>
                    </div>
                  </div>
                 
                 
                </div>
              </div>
              <!-- SubTask loop ends -->
              {% endfor %}

              {% else %}
              <div class="d-flex justify-content-center">
                <p>No Response Yet</p>
              </div>
              {% endif %}
                {% if callback.status ==  0  %}       
                <div class="row d-flex justify-content-center">
                  <a href="{% url 'create_response' callback.id %}" data-toggle="modal" data-title="New Response"
                    data-target="#CallBackForm" class=" mx-1 btn btn-sm btn-primary">New
                    Response</a>
                    {% if callback.callresponse_set.all|length %}
                    <a href="{% url 'complete_callback' callback.id %}" class="ajax-get btn btn-sm btn-primary"> Mark Solved
                    </a>
                    {% endif %}
              </div>
                {% endif %}
              
            </div>
          </div>

        </div>
        {% endfor %}
      </div>
      {% else %}

          <div class="card-body d-flex justify-content-center">
            <div class="">No Service Request Yet</div>
          </div>

        {% endif %}


    </div>
  </div>