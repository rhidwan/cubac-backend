{% load static %}

<div class="card shadow mb-4">
  <div class="card-header py-3">
    <h6 class="m-0 font-weight-bolder text-primary">Todo List

      <div class="float-right">
        <a href="{% url 'todo_report' %}" data-toggle="modal" data-title="Generate New report"
          data-target="#CallBackForm" class="btn btn-sm btn-primary">Generate Report</a>


        <a href="{% url 'create_task' %}" data-toggle="modal" data-title="Create New task" data-target="#CallBackForm"
          class="btn btn-sm btn-primary">New
          Task</a>

      </div>
    </h6>
  </div>

  <div class="card-body">
    <div class="row mb-1">
      <div class="col-4 offset-8">
        <input type="search" id="todo-search" value="" class="form-control" placeholder="Search">
      </div>
    </div>
    <div class="accordion" id="todoaccordion">
      {% if tasks %}
      {% for task in tasks %}
      <div class="card border border-primary mb-2">
        <div class="card-header bg-default" id="heading{{forloop.counter}}e">
          <div data-toggle="collapse" data-target="#collapse{{forloop.counter}}" aria-expanded="true"
            aria-controls="collapse{{forloop.counter}}">
            <div class="row">
              <div class="col-5">
                <div class="mb-2">
                  <span class="font-weight-bold text-gray-900 text-primary m-0">Assigned:</span>
                  {{task.assigned_date|date:'M d'}}

                </div>
              </div>
              <div class="col-2">
                {% if task.status == "Ongoing" %}
                <span class="badge badge-pill badge-danger">{{task.status}}</span>
                {% else %}
                <span class="badge badge-pill badge-success">{{task.status}}</span>
                {% endif %}
              </div>
              <div class="col-5">
                <div class="mb-2">
                  <span class="font-weight-bold text-gray-900 text-primary m-0">Deadline:</span>
                  {{task.deadline|date:'M d'}}
                </div>
              </div>
            </div>
            <div class="row">
              <div class="col-6">
                <div class="mb-2">
                  <span class="font-weight-bold text-gray-900 text-primary m-0">Recent Update:</span>
                  {{task.subtask_set.all.0.date|date:'M d'}}
                </div>
                <div class="mb-2">
                  <span class=" m-0 font-weight-bold text-gray-900  text-sm">By: </span>{{task.uploaded_by}}
                </div>
              </div>
              <div class="col-6">
                <div class="">
                  <span class="font-weight-bold text-gray-900 text-primary m-0">Concern:
                  </span>{{task.responsible_person.name}}
                  <p class="text-gray-900 m-0">{{task.responsible_person2.name}}</p>
                </div>
              </div>
            </div>
            <div class="row">
              <div class="col-12 mb-2 font-weight-bold ">
                <span class="font-weight-bold  m-0 text-primary">Task-{{task.id}}: </span> {{task.name}}

              </div>
              <div class="col-12">
                <span class="font-weight-bold text-primary m-0">Responses: </span>
                {{task.subtask_set.all.0.description}}

              </div>

            </div>

          </div>
        </div>
        <div id="collapse{{forloop.counter}}" class="collapse" aria-labelledby="heading{{forloop.counter}}"
          data-parent="#todoaccordion">
          <div class="card-body">
            {% if task.subtask_set.all|length %}
            {% for subtask in task.subtask_set.all %}
            <div class="row mb-2 border-bottom">
              <div class="col-3">
                <div class="mb-2">
                  {% if subtask.attachment %}
                  <a href="{{subtask.attachment.url}}" class="image">
                    <img class="img-fluid img-thumbnail" src="{{subtask.attachment_thumb.url}}" alt="avatar" />
                  </a>
                  {% else %}
                  <span><i class="far fa-image fa-3x"></i></span>
                  {% endif %}
                </div>
                <div class="mt-1">
                  {% if subtask.file_attachment %}
                  <p>
                    <a href="{{subtask.file_attachment.url}}" download="download"><i
                        class="fas fa-paperclip"></i>File</a>
                  </p>
                  {% endif %}
                </div>
                <div class="mb-2">
                  <span class="font-weight-bold text-gray-900 text-primary m-0">Date: </span>{{subtask.date|date:'M d'}}
                </div>
                <div class="col-2 mt-2">
                  <!-- <a href="{% url 'delete_sub_task' subtask.id %}"
                      class="ajax-get my-1 btn btn-sm btn-outline-danger">Delete</a> -->

                  <a href="{% url 'add_query' subtask.id %}" data-toggle="modal" data-title="Add Query/Response"
                    data-target="#CallBackForm" class="btn btn-sm btn-outline-primary">Query</a>
                </div>

              </div>
              <div class="col-9">
                <div class="mb-2">
                  <span class="font-weight-bold text-gray-900 text-primary m-0">Description: </span>{{subtask.description}}
                </div>
              </div>
            </div>
            {% if subtask.querysubtask_set.all|length %}
            <div class="bg-gradient-light">
              {% for query in subtask.querysubtask_set.all %}
              <div class="row mb-2 border-bottom">
                <div class="col-3">

                </div>
                <div class="col-6">
                  <div class="mb-2">
                    <p class="font-weight-bold text-gray-900 text-primary m-0">{{query.get_category_display}}</p>
                    <p class="text-gray-900 m-0">{{query.description}}</p>
                    <p class="text-muted text-sm">from: {{query.uploaded_by}}</p>
                  </div>
                </div>

                <div class="col-3">
                  <p class="font-weight-bold text-gray-900 text-primary m-0">Date: </p>
                  <p class="text-gray-900 m-0">{{query.inserted_at|date:'M d, Y'}}</p>
                </div>
              </div>
              {% endfor %}
              <div class="d-flex mb-2 justify-content-center">
                <a href="{% url 'add_query' subtask.id %}" data-toggle="modal" data-title="Add Query/Response"
                  data-target="#CallBackForm" class="btn btn-sm btn-outline-primary">Add Query/Respond To Query</a>
              </div>
            </div>
            {% endif %}


            <!-- SubTask loop ends -->
            {% endfor %}

            {% else %}
            <div class="d-flex justify-content-center">
              <p>No Subtask Yet</p>
            </div>
            {% endif %}
            <div class="row d-flex justify-content-center">
              {% if task.status == "Ongoing" %}
              <a href="{% url 'create_subtask' task.id %}" data-toggle="modal" data-title="Create new Subtask"
                data-target="#CallBackForm" class="mx-1 btn btn-sm btn-primary">New
                Response</a>
              <a href="{% url 'complete_task' task.id %}" class="ajax-get btn btn-sm btn-primary"> Mark Complete
              </a>
              {% endif %}
            </div>
          </div>
        </div>

      </div>
      {% endfor %}
      {% else %}
      <div class="card">
        <div class="card-body">
          No Tasks yet
        </div>
      </div>
      {% endif %}

    </div>


  </div>
</div>
